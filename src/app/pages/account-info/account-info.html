<div class="account-info-page">
  <div class="account-container">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <a routerLink="/account" routerLinkActive="active" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <span>Thông tin tài khoản</span>
        </a>
        <a routerLink="/account/wallet" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
            <line x1="1" y1="10" x2="23" y2="10"/>
          </svg>
          <span>Ví của tôi</span>
        </a>
        <a routerLink="/account/vat" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <span>Thông tin xuất hóa đơn VAT</span>
        </a>
        <a routerLink="/account/orders" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          <span>Đơn hàng đã mua</span>
        </a>
        <a routerLink="/account/activity" class="nav-item">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          <span>Nhật ký hoạt động</span>
        </a>
        <button class="nav-item logout-item" (click)="authService.logout()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          <span>Đăng xuất</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      @if (isLoading()) {
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Đang tải thông tin...</p>
        </div>
      } @else if (errorMessage()) {
        <div class="error-container">
          <p>{{ errorMessage() }}</p>
          <button class="btn-retry" (click)="loadProfile()">Thử lại</button>
        </div>
      } @else if (profile()) {
        <!-- Account Information Card -->
        <div class="info-card">
          <div class="card-header">
            <h2 class="card-title">Thông tin tài khoản</h2>
            <button class="btn-edit" (click)="navigateToEdit()">Sửa Thông Tin</button>
          </div>

          <div class="account-info-content">
            <!-- Left: Account Details -->
            <div class="account-details">
              <!-- Level Indicator -->
              <div class="level-section">
                <div class="level-badge">LV{{ getLevelInfo().level }}</div>
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getLevelInfo().progress"></div>
                  </div>
                  <p class="progress-text">
                    Hãy mua bán thêm {{ formatPrice(getLevelInfo().nextLevelAmount - getLevelInfo().currentAmount) }}₫ để lên level tiếp theo
                  </p>
                </div>
              </div>

              <!-- Account Details List -->
              <div class="details-list">
                <div class="detail-item">
                  <span class="detail-label">Tài khoản:</span>
                  <span class="detail-value">@{{ profile()!.username }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Trạng thái tài khoản:</span>
                  @if (profile()!.isVerified) {
                    <span class="badge-verified">Tài khoản đã xác thực</span>
                  } @else {
                    <span class="badge-unverified">Chưa xác thực</span>
                  }
                </div>
                <div class="detail-item">
                  <span class="detail-label">Tên gian hàng:</span>
                  <span class="detail-value">{{ profile()!.shopName || 'Chưa cập nhật' }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value">{{ profile()!.email }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Ngày đăng ký:</span>
                  <span class="detail-value">{{ formatDate(profile()!.createdAt) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Đã mua:</span>
                  <span class="detail-value">{{ profile()!.totalPurchases }} sản phẩm</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Số gian hàng:</span>
                  <span class="detail-value">{{ profile()!.totalShops || 0 }} gian hàng</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Đã bán:</span>
                  <span class="detail-value">{{ profile()!.totalSales || 0 }} sản phẩm</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Bảo mật 2 lớp:</span>
                  @if (profile()!.twoFactorEnabled) {
                    <span class="badge-enabled">Đã bật</span>
                  } @else {
                    <span class="badge-disabled">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                      </svg>
                      Chưa bật
                    </span>
                  }
                </div>
              </div>
            </div>

            <!-- Right: Profile Picture & Actions -->
            <div class="profile-section">
              <div class="profile-avatar-large">
                <span class="avatar-initial">{{ (profile()!.username || 'U')[0].toUpperCase() }}</span>
              </div>
              <div class="profile-username">@{{ profile()!.username }}</div>
              <button class="btn-shop" (click)="navigateToShop()">Gian Hàng</button>
            </div>
          </div>
        </div>

        <!-- Login Information Card -->
        <div class="info-card">
          <div class="card-header">
            <h2 class="card-title">Thông tin đăng nhập</h2>
            <button 
              class="btn-change-password" 
              (click)="openChangePasswordModal()"
              [disabled]="!canChangePassword()"
            >
              Đổi Mật Khẩu
            </button>
          </div>
          <div class="login-info-content">
            <div class="detail-item">
              <span class="detail-label">ID:</span>
              <span class="detail-value">@{{ profile()!.username }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Mật khẩu:</span>
              <span class="detail-value password-masked">••••••••</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Xác thực 2FA:</span>
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  [checked]="profile()!.twoFactorEnabled" 
                  [disabled]="isToggling2FA()"
                  (change)="toggle2FA()"
                >
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Bank Information Card -->
        <div class="info-card">
          <div class="card-header">
            <h2 class="card-title">Thông tin ngân hàng</h2>
            <button class="btn-add-bank" (click)="openBankInfoModal()">
              @if (bankInfo()?.bankName) {
                Sửa Thông Tin
              } @else {
                + Thêm Ngân Hàng
              }
            </button>
          </div>
          <div class="bank-info-content">
            @if (bankInfo()?.bankName) {
              <div class="bank-item">
                @if (hasBankLogo(bankInfo()!.bankName)) {
                  <div class="bank-logo">
                    <img 
                      [src]="getBankLogo(bankInfo()!.bankName)" 
                      [alt]="bankInfo()!.bankName"
                      class="bank-logo-image"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <div class="bank-icon-fallback" style="display: none;">
                      {{ (bankInfo()!.bankName || 'B')[0].toUpperCase() }}
                    </div>
                  </div>
                } @else {
                  <div class="bank-icon">{{ (bankInfo()!.bankName || 'B')[0].toUpperCase() }}</div>
                }
                <div class="bank-details">
                  <div class="bank-name">{{ bankInfo()!.bankName }} ({{ bankInfo()!.bankAccountNumber }})</div>
                  <div class="bank-account-name">{{ bankInfo()!.bankAccountHolder }}</div>
                  @if (bankInfo()!.bankBranch) {
                    <div class="bank-branch">{{ bankInfo()!.bankBranch }}</div>
                  }
                </div>
              </div>
            } @else {
              <div class="empty-bank">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <p>Chưa thêm thông tin</p>
              </div>
            }
          </div>
        </div>
      }
    </main>
  </div>
</div>

<!-- Change Password Modal -->
@if (showChangePasswordModal()) {
  <div class="modal-overlay" (click)="closeChangePasswordModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Đổi mật khẩu</h2>
        <button class="modal-close" (click)="closeChangePasswordModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        @if (passwordError()) {
          <div class="alert alert-error">{{ passwordError() }}</div>
        }
        @if (passwordSuccess()) {
          <div class="alert alert-success">{{ passwordSuccess() }}</div>
        }

        <div class="form-group">
          <label class="form-label">Mật khẩu hiện tại</label>
          <div class="input-with-icon">
            <input 
              [type]="showCurrentPassword() ? 'text' : 'password'"
              class="form-input"
              placeholder="Nhập mật khẩu hiện tại"
              [value]="passwordForm().currentPassword"
              (input)="updateCurrentPassword($event)"
            />
            <button 
              type="button"
              class="icon-button"
              (click)="togglePasswordVisibility('current')"
            >
              @if (showCurrentPassword()) {
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                  <line x1="1" y1="1" x2="23" y2="23"/>
                </svg>
              } @else {
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              }
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Mật khẩu mới</label>
          <div class="input-with-icon">
            <input 
              [type]="showNewPassword() ? 'text' : 'password'"
              class="form-input"
              placeholder="Nhập mật khẩu mới"
              [value]="passwordForm().newPassword"
              (input)="updateNewPassword($event)"
            />
            <button 
              type="button"
              class="icon-button"
              (click)="togglePasswordVisibility('new')"
            >
              @if (showNewPassword()) {
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                  <line x1="1" y1="1" x2="23" y2="23"/>
                </svg>
              } @else {
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              }
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Nhập lại mật khẩu</label>
          <div class="input-with-icon">
            <input 
              [type]="showConfirmPassword() ? 'text' : 'password'"
              class="form-input"
              placeholder="Nhập lại mật khẩu mới"
              [value]="passwordForm().confirmNewPassword"
              (input)="updateConfirmPassword($event)"
            />
            <button 
              type="button"
              class="icon-button"
              (click)="togglePasswordVisibility('confirm')"
            >
              @if (showConfirmPassword()) {
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                  <line x1="1" y1="1" x2="23" y2="23"/>
                </svg>
              } @else {
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              }
            </button>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeChangePasswordModal()">Hủy</button>
        <button 
          class="btn-save" 
          (click)="changePassword()"
          [disabled]="isChangingPassword()"
        >
          @if (isChangingPassword()) {
            Đang lưu...
          } @else {
            Lưu Lại
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Bank Info Modal -->
@if (showBankInfoModal()) {
  <div class="modal-overlay" (click)="closeBankInfoModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Thêm thông tin ngân hàng</h2>
        <button class="modal-close" (click)="closeBankInfoModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        @if (bankError()) {
          <div class="alert alert-error">{{ bankError() }}</div>
        }
        @if (bankSuccess()) {
          <div class="alert alert-success">{{ bankSuccess() }}</div>
        }

        <div class="form-group">
          <label class="form-label">Tên ngân hàng</label>
          <select 
            class="form-input"
            [value]="bankForm().bankName"
            (change)="updateBankName($event)"
          >
            <option value="">Chọn ngân hàng</option>
            <option value="Vietcombank">Vietcombank</option>
            <option value="BIDV">BIDV</option>
            <option value="Vietinbank">Vietinbank</option>
            <option value="Agribank">Agribank</option>
            <option value="Techcombank">Techcombank</option>
            <option value="ACB">ACB</option>
            <option value="TPBank">TPBank</option>
            <option value="VPBank">VPBank</option>
            <option value="MBBank">MBBank</option>
            <option value="Sacombank">Sacombank</option>
            <option value="SHB">SHB</option>
            <option value="VIB">VIB</option>
            <option value="HDBank">HDBank</option>
            <option value="MSB">MSB</option>
            <option value="OCB">OCB</option>
            <option value="Eximbank">Eximbank</option>
            <option value="SeABank">SeABank</option>
            <option value="PGBank">PGBank</option>
            <option value="VietABank">VietABank</option>
            <option value="BacABank">BacABank</option>
            <option value="SCB">SCB</option>
            <option value="Khác">Khác</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Người thụ hưởng</label>
          <input 
            type="text"
            class="form-input"
            placeholder="Nhập tên chủ tài khoản"
            [value]="bankForm().bankAccountHolder"
            (input)="updateBankAccountHolder($event)"
            maxlength="100"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Số tài khoản</label>
          <input 
            type="text"
            class="form-input"
            placeholder="Nhập số tài khoản"
            [value]="bankForm().bankAccountNumber"
            (input)="updateBankAccountNumber($event)"
            maxlength="50"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Chi nhánh (Tùy chọn)</label>
          <input 
            type="text"
            class="form-input"
            placeholder="Nhập chi nhánh"
            [value]="bankForm().bankBranch"
            (input)="updateBankBranch($event)"
            maxlength="200"
          />
        </div>

        <div class="note-box">
          <div class="note-title">Lưu ý:</div>
          <ul class="note-list">
            <li>Hãy kiểm tra để đảm bảo thông tin tài khoản chính xác.</li>
            <li>Giao dịch rút tiền sẽ gặp lỗi nếu thông tin tài khoản không chính xác.</li>
          </ul>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeBankInfoModal()">Hủy</button>
        <button 
          class="btn-save" 
          (click)="saveBankInfo()"
          [disabled]="isSavingBankInfo()"
        >
          @if (isSavingBankInfo()) {
            Đang lưu...
          } @else {
            Lưu Lại
          }
        </button>
      </div>
    </div>
  </div>
}
