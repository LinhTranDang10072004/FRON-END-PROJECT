<div class="cart-page">
  <div class="container">
    <!-- Header -->
    <div class="cart-header">
      <button class="btn-back" (click)="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Quay lại
      </button>
      <h1 class="cart-title">Giỏ hàng</h1>
    </div>

    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Đang tải giỏ hàng...</p>
      </div>
    } @else if (errorMessage()) {
      <div class="error-state">
        <p>{{ errorMessage() }}</p>
        <button class="btn-retry" (click)="loadCart()">Thử lại</button>
      </div>
    } @else if (!cart() || cart()!.items.length === 0) {
      <div class="empty-cart">
        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 22C9.55228 22 10 21.5523 10 21C10 20.4477 9.55228 20 9 20C8.44772 20 8 20.4477 8 21C8 21.5523 8.44772 22 9 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M20 22C20.5523 22 21 21.5523 21 21C21 20.4477 20.5523 20 20 20C19.4477 20 19 20.4477 19 21C19 21.5523 19.4477 22 20 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M1 1H5L7.68 14.39C7.77144 14.8504 8.02191 15.264 8.38755 15.5583C8.75318 15.8526 9.2107 16.009 9.68 16H19C19.4693 16.009 19.9268 15.8526 20.2925 15.5583C20.6581 15.264 20.9086 14.8504 21 14.39L22.6 7H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h2>Giỏ hàng trống</h2>
        <p>Bạn chưa có sản phẩm nào trong giỏ hàng</p>
        <button class="btn-shopping" (click)="goBack()">Tiếp tục mua sắm</button>
      </div>
    } @else {
      <!-- Cart Items Table -->
      <div class="cart-content">
        <table class="cart-table">
          <thead>
            <tr>
              <th class="col-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="isAllSelected()"
                  (change)="toggleSelectAll()"
                  class="checkbox"
                />
              </th>
              <th class="col-product">Sản phẩm</th>
              <th class="col-price">Đơn giá</th>
              <th class="col-quantity">Số lượng</th>
              <th class="col-amount">Số tiền</th>
              <th class="col-action">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            @for (item of cart()!.items; track item.id) {
              <tr class="cart-item-row">
                <td class="col-checkbox">
                  <input 
                    type="checkbox" 
                    [checked]="selectedItems().has(item.id)"
                    (change)="toggleSelectItem(item.id)"
                    class="checkbox"
                  />
                </td>
                <td class="col-product">
                  <div class="product-info">
                    <img 
                      [src]="item.product.imageUrl || '/assets/images/placeholder.png'" 
                      [alt]="item.product.name"
                      class="product-image"
                      onerror="this.src='/assets/images/placeholder.png'"
                    />
                    <div class="product-details">
                      <h3 class="product-name">{{ item.product.name }}</h3>
                      @if (item.productOption) {
                        <p class="product-option">{{ item.productOption.name }}</p>
                      }
                      <div class="seller-info">
                        <span class="seller-name">Người bán: {{ item.product.seller.shopName || item.product.seller.username }}</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="verified-icon">
                          <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="col-price">
                  <div class="price-info">
                    @if (item.discountPrice && item.discountPrice < item.unitPrice) {
                      <span class="price-original">{{ formatPrice(item.unitPrice) }}₫</span>
                      <span class="price-discount">{{ formatPrice(item.discountPrice) }}₫</span>
                    } @else {
                      <span class="price-current">{{ formatPrice(item.unitPrice) }}₫</span>
                    }
                  </div>
                </td>
                <td class="col-quantity">
                  <div class="quantity-controls">
                    <button 
                      class="quantity-btn" 
                      (click)="decreaseQuantity(item)"
                      [disabled]="item.quantity <= 1"
                    >-</button>
                    <input 
                      type="number" 
                      class="quantity-input" 
                      [value]="item.quantity" 
                      min="1"
                      (change)="updateQuantity(item.id, $any($event.target).value)"
                      readonly
                    />
                    <button 
                      class="quantity-btn" 
                      (click)="increaseQuantity(item)"
                    >+</button>
                  </div>
                </td>
                <td class="col-amount">
                  <span class="amount">{{ formatPrice(item.totalPrice) }}₫</span>
                </td>
                <td class="col-action">
                  <button 
                    class="btn-delete" 
                    (click)="removeItem(item.id)"
                    title="Xóa sản phẩm"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>

        <!-- Cart Summary -->
        <div class="cart-summary">
          <div class="summary-left">
            <label class="select-all-label">
              <input 
                type="checkbox" 
                [checked]="isAllSelected()"
                (change)="toggleSelectAll()"
                class="checkbox"
              />
              <span>Chọn tất cả ({{ cart()!.itemCount }})</span>
            </label>
            <button class="btn-delete-selected" (click)="removeSelectedItems()">Xóa</button>
            <button class="btn-remove-out-of-stock">Bỏ sản phẩm hết hàng</button>
          </div>
          <div class="summary-right">
            <div class="total-info">
              <span class="total-label">Tổng cộng ({{ selectedItemsCount() }}) sản phẩm:</span>
              <span class="total-amount">{{ formatPrice(totalSelectedAmount()) }}₫</span>
            </div>
            <button 
              class="btn-checkout" 
              (click)="checkout()"
              [disabled]="selectedItemsCount() === 0"
            >
              Mua Hàng
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Similar Products Section -->
    @if (similarProducts().length > 0) {
      <section class="similar-products-section">
        <h2 class="section-title">Có thể bạn cũng thích</h2>
        <div class="similar-products-grid">
          @for (product of similarProducts(); track product.id) {
            <div class="product-card" [routerLink]="['/san-pham', product.productCode]">
              <div class="product-image-wrapper">
                <img 
                  [src]="product.imageUrl || '/assets/images/placeholder.png'" 
                  [alt]="product.name"
                  class="product-card-image"
                  onerror="this.src='/assets/images/placeholder.png'"
                />
              </div>
              <div class="product-card-info">
                <h3 class="product-card-name">{{ product.name }}</h3>
                <div class="product-card-price">
                  @if (product.discountPrice) {
                    <span class="price-original">{{ formatPrice(product.price) }}₫</span>
                    <span class="price-discount">{{ formatPrice(product.discountPrice) }}₫</span>
                  } @else {
                    <span class="price-current">{{ formatPrice(product.price) }}₫</span>
                  }
                </div>
                <div class="product-card-meta">
                  <span class="rating">⭐ {{ product.rating.toFixed(1) }}</span>
                  <span class="sales">Đã bán: {{ formatPrice(product.totalSales) }}</span>
                </div>
              </div>
            </div>
          }
        </div>
      </section>
    }
  </div>
</div>

