<div class="category-page">
  <div class="category-container">
    <!-- Left Sidebar Filters -->
    <aside class="sidebar-filters">
      <h2 class="filter-title">Bộ lọc</h2>
      
      <!-- Category Filters (Checkboxes) -->
      <div class="filter-section">
        <h3 class="filter-section-title">Danh mục</h3>
        <div class="filter-checkboxes">
          @for (category of allCategories(); track category) {
            <label class="checkbox-label">
              <input
                type="checkbox"
                [checked]="selectedCategories().includes(category)"
                (change)="onCategoryToggle(category, $event)"
              />
              <span class="checkbox-text">{{ category }}</span>
            </label>
          }
        </div>
      </div>

      <!-- EmailType Filters (Checkboxes) - Only show for Email category -->
      @if (categoryName() === 'Email' && emailTypes().length > 0) {
        <div class="filter-section">
          <h3 class="filter-section-title">Loại email</h3>
          <div class="filter-checkboxes">
            @for (emailType of emailTypes(); track emailType) {
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="selectedEmailTypes().includes(emailType)"
                  (change)="onEmailTypeToggle(emailType, $event)"
                />
                <span class="checkbox-text">
                  @if (emailType === 'Other') {
                    Loại mail khác
                  } @else {
                    {{ emailType }}
                  }
                </span>
              </label>
            }
          </div>
        </div>
      }

      <!-- ServiceType Filters (Checkboxes) -->
      <div class="filter-section">
        <h3 class="filter-section-title">Loại dịch vụ</h3>
        <div class="filter-checkboxes">
          @for (serviceType of serviceTypes(); track serviceType) {
            <label class="checkbox-label">
              <input
                type="checkbox"
                [checked]="selectedServiceTypes().includes(serviceType)"
                (change)="onServiceTypeToggle(serviceType, $event)"
              />
              <span class="checkbox-text">{{ serviceType }}</span>
            </label>
          }
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
      <!-- Breadcrumb and Search Row -->
      <div class="top-bar">
        <div class="breadcrumb">
          <a routerLink="/">Trang chủ</a>
          <span class="separator">/</span>
          <span class="current">Sản phẩm</span>
        </div>
        <div class="search-box-wrapper">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21L16.65 16.65"/>
          </svg>
          <input
            type="text"
            class="search-input"
            placeholder="Tìm kiếm"
            #searchInput
          />
        </div>
      </div>

      <!-- Page Title -->
      <h1 class="page-title">{{ categoryName() || 'Tất cả sản phẩm' }}</h1>

      <!-- Sort Bar and Product Count -->
      <div class="sort-bar">
        <div class="sort-left">
          <span class="sort-label">Sắp xếp theo</span>
          <div class="sort-buttons">
            @for (sort of sortOptions; track sort.value) {
              <button
                class="sort-btn"
                [class.active]="sortBy() === sort.value"
                (click)="onSortChange(sort.value)"
              >
                {{ sort.label }}
                @if (sort.value === 'price_asc') {
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                }
              </button>
            }
          </div>
        </div>
        <div class="sort-right">
          <span class="product-count">{{ total() }} sản phẩm</span>
          <div class="pagination-top">
            <button
              class="pagination-arrow"
              [disabled]="currentPage() === 1"
              (click)="onPageChange(currentPage() - 1)"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18L9 12L15 6"/>
              </svg>
            </button>
            <span class="pagination-info">{{ currentPage() }} / {{ totalPages() }}</span>
            <button
              class="pagination-arrow"
              [disabled]="currentPage() === totalPages()"
              (click)="onPageChange(currentPage() + 1)"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18L15 12L9 6"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      @if (isLoading()) {
        <div class="loading-state">
          <p>Đang tải sản phẩm...</p>
        </div>
      }

      <!-- Product Grid -->
      @if (!isLoading() && products().length > 0) {
        <div class="product-grid">
          @for (product of products(); track product.id) {
            <a [routerLink]="['/san-pham', product.productCode]" class="product-card-link">
              <div class="product-card">
                <div class="product-image-wrapper">
                  <div class="product-image">
                    <img [src]="getProductImage(product)" [alt]="product.name" />
                  </div>
                  @if (product.isFeatured) {
                    <span class="featured-badge">Nổi bật</span>
                  }
                  <span class="unique-badge">Không trùng</span>
                </div>
                <div class="product-info">
                  <h3 class="product-name">{{ product.name }}</h3>
                  @if (product.description) {
                    <p class="product-description">{{ product.description }}</p>
                  }
                  <div class="product-price-range">
                    {{ formatPriceRange(product) }}
                  </div>
                  <div class="product-details">
                    <div class="product-stock">
                      <span class="stock-label">Tồn kho:</span>
                      <span class="stock-value">{{ product.stock }}</span>
                    </div>
                    <div class="product-metrics">
                      <div class="metric-item">
                        @if (getProductRating(product) > 0) {
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                          </svg>
                          <span class="rating-value">{{ formatRating(getProductRating(product)) }}</span>
                          <span class="rating-count">({{ product.totalRatings }})</span>
                        } @else {
                          <span class="no-rating">Chưa có đánh giá</span>
                        }
                      </div>
                      <div class="metric-item">
                        <span class="metric-label">Đã bán:</span>
                        <span class="metric-value">{{ formatSales(product.totalSales) }}</span>
                      </div>
                      <div class="metric-item">
                        <span class="metric-label">Khiếu nại:</span>
                        <span class="metric-value">{{ getComplaintPercentage(product) }}%</span>
                      </div>
                    </div>
                    <div class="seller-info">
                      <span class="seller-label">Người bán:</span>
                      <a [routerLink]="['/seller', product.seller.id]" class="seller-link" (click)="$event.stopPropagation()">
                        <span class="seller-name">{{ product.seller.shopName || product.seller.username }}</span>
                        @if (product.seller.isVerified) {
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="verified-icon" title="Đã xác thực">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                          </svg>
                        }
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          }
        </div>

        <!-- Pagination -->
        @if (totalPages() > 1) {
          <div class="pagination">
            <button
              class="pagination-btn"
              [disabled]="currentPage() === 1"
              (click)="onPageChange(currentPage() - 1)"
            >
              Trước
            </button>
            @for (pageNum of getPageNumbers(); track pageNum) {
              @if (isEllipsis(pageNum)) {
                <span class="pagination-ellipsis">...</span>
              } @else {
                <button
                  class="pagination-btn"
                  [class.active]="currentPage() === pageNum"
                  (click)="onPageChange(pageNum)"
                >
                  {{ pageNum }}
                </button>
              }
            }
            <button
              class="pagination-btn"
              [disabled]="currentPage() === totalPages()"
              (click)="onPageChange(currentPage() + 1)"
            >
              Sau
            </button>
          </div>
        }
      }

      <!-- Empty State -->
      @if (!isLoading() && products().length === 0) {
        <div class="empty-state">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21L16.65 16.65"/>
          </svg>
          <h3>Không tìm thấy sản phẩm nào</h3>
          <p>Không có sản phẩm nào trong danh mục "{{ categoryName() }}"</p>
        </div>
      }
    </main>
  </div>
</div>
